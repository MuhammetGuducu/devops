name: Vorschau - TemporÃ¤re Umgebung deployen

on:
  pull_request:
    types: [opened, synchronize, closed]

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: eu-central-1
  # Use a single, shared ECR repository for all preview images to save costs
  SHARED_ECR_REPOSITORY: devops-demo-preview-shared

jobs:
  deploy-preview:
    name: Job - Vorschau deployen/zerstÃ¶ren
    runs-on: ubuntu-latest
    # This job should not run if the PR is just being closed. The 'destroy' job will handle that.
    if: github.event.action != 'closed'
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4

      - name: AWS-Zugangsdaten konfigurieren
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Node.js einrichten
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: App-Tests ausfÃ¼hren
        run: |
          npm ci
          npm test

      - name: Bei Amazon ECR anmelden
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Shared ECR Repository sicherstellen
        run: |
          aws ecr describe-repositories --repository-names ${{ env.SHARED_ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} 2>/dev/null || \
          aws ecr create-repository --repository-name ${{ env.SHARED_ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} --image-scanning-configuration scanOnPush=true

      # Build and Push Docker image
      - name: Docker-Image bauen & pushen
        id: build-image
        run: |
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          IMAGE_TAG="pr-${{ github.event.number }}"
          
          docker build \
            --build-arg VERSION="preview-pr${{ github.event.number }}" \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            -t $ECR_REGISTRY/${{ env.SHARED_ECR_REPOSITORY }}:$IMAGE_TAG .
          
          docker push $ECR_REGISTRY/${{ env.SHARED_ECR_REPOSITORY }}:$IMAGE_TAG
          echo "IMAGE_URI=$ECR_REGISTRY/${{ env.SHARED_ECR_REPOSITORY }}:$IMAGE_TAG" >> $GITHUB_ENV

      # Deploy CDK Stack after the image is available
      - name: CDK Stack deployen
        working-directory: ./infra
        run: |
          npm ci
          npm run build
          npx cdk deploy \
            --context pr_number=${{ github.event.number }} \
            --require-approval never \
            --outputs-file ../cdk-outputs.json

      - name: URL im Pull Request posten
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.number }}
          body: |
            ## ðŸš€ Preview Environment Ready
            **URL:** $(jq -r '.["bachelor-preview-pr-${{ github.event.number }}"].ServiceURL' cdk-outputs.json)
            **Image:** `${{ env.IMAGE_URI }}`
            This environment will be automatically destroyed when the PR is closed.

  destroy-preview:
    name: Job - Vorschau zerstÃ¶ren
    runs-on: ubuntu-latest
    # This job ONLY runs when the PR is closed.
    if: github.event.action == 'closed'
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4

      - name: AWS-Zugangsdaten konfigurieren
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Node.js einrichten
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Stack zerstÃ¶ren
        working-directory: ./infra
        run: |
          npm ci
          npm run build
          npx cdk destroy \
            --context pr_number=${{ github.event.number }} \
            --force
      
      - name: Kommentar im Pull Request aktualisieren
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.number }}
          body: |
            ## Preview Environment Destroyed
            The environment has been successfully torn down.